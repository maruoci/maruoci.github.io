---
title: JVM学习(二)：对象创建
date: 2018-10-17 22:55:30
categories:
- Java虚拟机
tags:
- Java
- Jvm
---

> 根据深入理解Java虚拟机摘抄一些JVM内存管理的一些重点。旨在深入理解Java中的对象的创建、布局等。

## 参考书籍

 **深入理解Java虚拟机（第二版）**
 
 <!--more-->
 
## 对象的创建过程

![](http://pbsg2r9io.bkt.clouddn.com/18-10-18/85306971.jpg)

### 内存的分配

#### 内存分配方式

指针碰撞：如果堆内存是规整的，空闲内存一边，已使用内存一边，中间一个指针作为分界点。则分配内存仅仅是把指针向空闲空间挪动一段与对象大小相等的距离。

空闲列表：如果堆内存是不规整的，虚拟机需要维护一个列表记录内存是空闲还是已使用的。分配的时候找到一块足够大的空间划分给对象实例。 

> 具体选择哪种分配方式由堆内存是否规整决定，堆内存是否规整则由所使用的的垃圾收集器是否带有压缩整理功能决定。
> 使用Serial、ParNew等带Compact过程的收集器时，系统采用指针碰撞方式分配，而使用CMS的基于Mark-Sweep算法收集器通常采用空闲列表。

#### 内存分配时的并发

频繁创建对象，并发情况下可能会导致对象A使用指针分配内存，指针在未修改时，对象B使用同一个指针分配内存。解决该问题有两种方案。

**同步** 

对分配内存的动作进行同步处理，虚拟机在此才用CAS加失败重试的方式保证更新操作的原子性。

**TLAB线程本地分配缓冲**

堆中为每个线程预分配一块内存，在各自缓冲区内进行分配。TLAB用完重新分配TLAB时才去同步锁定。

### 内存的初始化

 内存分配完成后，虚拟机将分配到的内存进行初始化为零值。也因此，对象实例字段不需代码初始化即可直接使用。
 
 > TLAB分配时，该初始化可以在分配时进行。
 
## 总结